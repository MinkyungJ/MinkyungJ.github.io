---
title: Service Monitoring
tags: [DevOps, Monitoring, Metric]
date: 2023-07-25 17:00 +0900
categories: [DevOps, Metric, Monitoring]
toc: true
---

## ❗️ 모니터링
> 쿼리 수 및 유형, 오류 수 및 유형, 처리 시간 및 서버 수명과 같은 시스템에 대한 실시간 양적 데이터를 수집, 처리, 집계 및 표시합니다.

### 모니터링의 목표
- 시간을 기준으로 측정되는 주요 메트릭을 최소화하여 **고가용성**을 달성하는 것
- 사용량을 추적하여, 배포에 앞서 세운 가설을 검증하고 개선하는 것
- 장기적인 트렌드를 분석하는 것 (Analyzing long-term trends)
- 시간 또는 실험 그룹에 따른 비교하는 것
- **대시보드**를 구축하여 데이터를 **시각화**해 효율적인 모니터링 하는 것
  - EX> Grafana
- **경고** (Alerting)을 통해 시스템의 고장이나 잠재적인 문제 파악하는 것

---

> 💡 계층적 모니터링이 왜 필요할까요?

모든 메트릭을 실시간으로 보는 것은 불가능할뿐더러, 너무 많은 메트릭을 모니터링하다 보면, 정말 중요한 신호를 발견하기도 어렵기 때문입니다.

---

### 블랙박스 모니터링과 화이트박스 모니터링
> 블랙박스와 화이트박스의 구분은 박스(EX> 쿠버네티스 시스템, 애플리케이션, 등)를 기준으로 관찰자가 밖에서 바라보느냐, 안에서 바라보느냐의 차이입니다.

- 블랙박스 모니터링: 사용자가 보는 것처럼 **외부**에 보이는 동작을 테스트하는 것을 의미합니다.
  - 스토리지, 메모리, CPU, 등 인프라 수준의 모니터링에 유용합니다.
  - 애플리케이션이 왜 오류를 내는지 알 수 없습니다.
  - EX> 쿠버네티스 시스템의 경우, 클러스터 정상 작동 여부 등 쿠버네티스 컴포넌트 그 자체를 모니터링하는 방식입니다.

- 화이트박스 모니터링: 시스템 **내부**의 측정 기준에 따라 모니터링하는 것을 의미합니다. 
  - 단순히 현상만 바라보는 것이 아닌, 현상이 발생한 **근거**를 알 수 있는 모니터링 방식입니다.
  - EX> HTTP 요청, 500 에러의 발생 횟수, 레이턴시 등

---

### 계층에 따른 모니터링 구분

#### 쿠버네티스

Kubernetes Layers를 **계층화**하는 이유는 무엇일까요?

- 클러스터 수준의 메트릭은 쿠버네티스 배포 성능에 대한 높은 수준의 개요를 제공해줍니다.
  - 하지만, 문제를 식별하고 클러스터를 관리하고 리소스를 최적화하는 데 도움이 되려면, 각 레이어에 대한 메트릭을 얻을 수 있는 위치를 알아야합니다.
  - 노드 > 클러스터 컴포넌트 > 파드 > 컨테이너

![Kubernetes Monitoring Layers](https://github.com/MinkyungJ/MinkyungJ.github.io/blob/main/_posts/Kubernetes_Layers.png?raw=true)*출처: Grafana Labs*

위의 다이어그램으로 예시를 들어보겠습니다. <br>
> 💡 클러스터 메트릭을 모니터링했을 때 약 50%의 메모리 사용률이 표시된다고 가정하였을 때, 한 단계 내려가서 각 노드의 메트릭을 모니터링하면 어떤 결과가 나올까요? <br>

컨테이너의 환경과 Pod가 어떤 컨테이너를 호스팅하냐에 따라 다르겠지만, 노드 중 하나는 100%의 메모리 사용률을 나타낼 수도 있습니다.
하지만 중요한 것은 문제는 나타나지만 원인은 알 수 없으며, 다시 Pod 단계로 내려가면 문제에 가까워지고 또 컨테이너 단계로 내려간다면 메모리 누수의 원인을 격리할 수 있을 겁니다. <br>
이는 **쿠버네티스 계층 메트릭**을 모니터링하는 것의 가치를 보여주는 간단한 예입니다.

#### 다른 예시
- ECS
  - 클러스터 > 서비스 > 태스크
- EC2: 인스턴스에 대한 메트릭만 볼 수 있습니다.
- Lambda: 함수에 대한 메트릭만 볼 수 있습니다.

---

## ❗️ 메트릭
> 메트릭이란, 시간에 따라 측정한 결과값입니다. 더 넓은 의미로 시스템의 상태, 동작 또는 성능을 측정하는데 사용되는 **수치 데이터**를 의미하기도 합니다.

### 메트릭의 특징
- **수치 데이터**: 메트릭은 수치로 나타낼 수 있는 정보여야 합니다.
- **시계열 데이터**: 메트릭은 일정한 시간 간격으로 기록되어 시계열 데이터로 관리됩니다.
- **측정 단위**: 메트릭은 측정 단위가 있어야 합니다.
  - 백분율(%), 초(s), 요청 수, 등
- **모니터링 대상**: CPU, 메모리, 네트워크, 디스크 등 시스템 또는 애플리케이션의 다양한 측면을 모니터링하는 메트릭들이 존재합니다.

---

### 주요한 특정 메트릭

> 모니터링은 시스템의 건강상태를 지속적으로 파악하고 문제를 조기에 감지하여 서비스의 **안정성**과 **가용성**을 보장해야합니다.

- **서버 리소스 사용률**을 모니터링하여 자원 부족으로 인한 성능 저하를 방지합니다.
- **네트워크 트래픽 패턴**을 모니터링하여 네트워크 병목 현상과 통신 오류를 파악합니다.
- 서비스의 **응답 시간**을 측정하여 사용자 경험과 품질을 평가합니다.
- 발생하는 **오류**들을 모니터링하여 신속하게 대응합니다.
- **트랜잭션 수**를 모니터링하여 트래픽의 증감을 파악하고 서비스의 인기도를 파악합니다.
- **서비스의 가용성**을 모니터링하여 서비스 다운타임을 최소화하고 SLA(Service Level Agreement)를 준수합니다.
- **로그**를 분석해 시스템의 상태와 잠재적 문제를 파악하고 디버깅에 활용합니다.
- **인프라 리소스**의 처리량을 모니터링하여 자원 확장이 필요한지 판단합니다.
- **보안 상태**를 모니터링하여 공격에 미리 감지하고 대응합니다.

---

> 💡 위와 같이 주요한 특정 메트릭들이 왜 중요할까요?

1. 특정 메트릭이 서비스와 밀접한 관련있을수록 사용자 경험에 **직접적인 영향**을 미칠 수 있으며 **높은 우선순위**를 가질 수 있습니다.
2. 장애를 예측하고 사전에 경고하는 메트릭은 **시스템 안정성**을 유지하는데 중요합니다. 서비스 다운타임을 피하고 사용자에게 영향을 최소화시킬 수 있습니다.
3. 리소스 사용량을 모니터링하여 비효율적인 부분을 발견하고 최적화 할 수 있으며 이는 **비용을 절감**하고 **성능을 향상**시킬 수 있습니다.
4. (새로운 기능 배포와 같은)변경을 감지하고 이상 징후를 파악하여 **성능 변화를 파악**할 수 있습니다.
5. 보안과 관련된 메트릭들은 시스템의 취약점이나 잠재적 위험 요소를 파악하고 대응하는데 도움이 됩니다.
6. 복잡한 시스템에서 트랜잭션 경로를 추적하는 메트릭은 잠재적 병목 현상이나 성능을 파악하는데 도움이 됩니다.
7. 중요한 특정 메트릭들은 SLA를 준수하는데 도움이 됩니다.

> 특정한 중요 메트릭을 설정하는 것은 시스템의 목적과 운영 환경을 이해하고, 실제 운영 경험을 통해 문제를 해결하거나 성능을 향상시키는 데 도움이 되기 때문에 중요하다고 생각합니다.

---

## ❗️ Reference
> About Monitoring from Google 
<https://sre.google/sre-book/monitoring-distributed-systems/>
> About Kubernetes Monitoring Layers From Grafana Labs
<https://grafana.com/blog/2023/01/25/monitoring-kubernetes-layers-key-metrics-to-know/>